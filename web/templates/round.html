<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Round.Name}} - Partitionly</title>
    <link rel="stylesheet" href="../static/css/main.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Montserrat+Alternates:wght@700&family=Audiowide&family=Bebas+Neue&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
    <div class="container">
        <header class="header">
            <a href="/" class="back-link"><i data-lucide="arrow-left" class="icon-inline"></i> Back to Home</a>
            <div class="logo-sign logo-sign-sm">
                <div class="logo-sign-plate">
                    <h1 class="logo logo-sm">Partitionly</h1>
                </div>
            </div>
        </header>

        <main class="main-content">
            <!-- Round Info Card -->
            <section class="card">
                <div class="round-header">
                    <h2>{{.Round.Name}}</h2>
                    <span class="badge badge-{{.Round.State}}" id="round-state">{{.Round.State}}</span>
                </div>

                <div class="round-meta">
                    <span class="mode-label">
                        {{if eq .Round.Mode "sample"}}<i data-lucide="music" class="icon-inline icon-primary"></i> Sample Mode{{else}}<i data-lucide="phone" class="icon-inline icon-primary"></i> Telephone Mode{{end}}
                    </span>
                </div>

                <!-- Join Code Display -->
                <div class="round-code-section">
                    <p class="section-title">Share Code</p>
                    <div class="round-code" id="round-code" title="Click to copy">{{.Code}}</div>
                    <p class="round-code-hint">Click to copy</p>
                </div>
                <!-- Leave Round Button (for participants) -->
                {{if .Participant}}
                <div class="leave-section mt-2">
                    <button class="btn btn-outline btn-sm" id="leave-round-btn">Leave Round</button>
                </div>
                {{end}}
            </section>

            <!-- Host Controls (only visible to host) -->
            {{if .Participant}}{{if .Participant.IsHost}}
            <section class="card" id="host-controls">
                <h2>Host Controls</h2>

                <!-- Sample Upload (Sample Mode Only) -->
                {{if eq .Round.Mode "sample"}}
                <div id="sample-upload-section">
                    <p class="section-title">Sample File</p>
                    {{if .Round.SampleFileID}}
                    <div class="file-status success">
                        <span><i data-lucide="check" class="icon-inline"></i> Sample uploaded</span>
                        <button class="btn btn-sm btn-outline" id="replace-sample-btn">Replace</button>
                    </div>
                    {{end}}
                    <div class="upload-area{{if .Round.SampleFileID}} hidden{{end}}" id="sample-upload-area">
                        <input type="file" id="sample-file-input" accept=".mp3,.wav,.m4a,.flac,.ogg,.aac">
                        <div class="upload-icon"><i data-lucide="music" class="icon-lg icon-primary"></i></div>
                        <p class="upload-text">Drop sample file here or click to browse</p>
                        <p class="upload-hint">MP3, WAV, M4A, FLAC, OGG, AAC (max 32MB)</p>
                    </div>
                    <div class="progress-bar hidden" id="sample-progress">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                    <p id="sample-upload-status" class="upload-status"></p>
                </div>
                {{end}}

                <!-- State Controls -->
                <div class="state-controls mt-2">
                    <p class="section-title">Round State</p>
                    <div class="action-row">
                        {{if eq .Round.State "waiting"}}
                        <button class="btn btn-primary" id="start-round-btn">Start Round</button>
                        {{else if eq .Round.State "active"}}
                        <button class="btn btn-outline" id="close-round-btn">Close Round</button>
                        {{end}}
                    </div>
                    <p class="state-hint text-muted mt-1">
                        {{if eq .Round.State "waiting"}}Participants can join. Start when ready.{{else if eq .Round.State "active"}}Uploads are open. Close when done.{{else}}Round is closed. No more uploads.{{end}}
                    </p>
                </div>

                <!-- Export (when closed) -->
                {{if eq .Round.State "closed"}}
                <div class="export-section mt-2">
                    <p class="section-title">Export</p>
                    <a href="/api/round/{{.Code}}/export" class="btn btn-secondary"><i data-lucide="download" class="icon-inline"></i> Download All Files (ZIP)</a>
                </div>
                {{end}}
            </section>
            {{end}}{{end}}

            <!-- Participants Card -->
            <section class="card">
                <div class="card-header-row">
                    <h2>Participants</h2>
                    <span class="participant-count" id="participant-count">{{len .Round.Participants}}</span>
                </div>
                <ul class="participants-list" id="participants-list">
                    {{range $id, $p := .Round.Participants}}
                    <li class="participant-item {{if index $.Round.Submissions $p.ID}}submitted{{else}}not-submitted{{end}}" data-id="{{$p.ID}}">
                        <div class="participant-info">
                            <span class="participant-name">{{$p.DisplayName}}</span>
                            {{if $p.IsHost}}<span class="badge badge-host">Host</span>{{end}}
                        </div>
                        {{if index $.Round.Submissions $p.ID}}
                        <span class="participant-status"><i data-lucide="check" class="icon-inline"></i></span>
                        {{else}}
                        <span class="participant-status pending"><i data-lucide="clock" class="icon-inline"></i></span>
                        {{end}}
                    </li>
                    {{end}}
                </ul>
                <div class="participants-legend">
                    <span class="legend-item"><span class="legend-dot submitted"></span> Uploaded</span>
                    <span class="legend-item"><span class="legend-dot not-submitted"></span> Pending</span>
                </div>
            </section>

            {{if .Participant}}
            <!-- Download Section (for participants) -->
            <section class="card" id="download-section">
                <h2>Download</h2>
                {{if eq .Round.Mode "sample"}}
                {{if .Round.SampleFileID}}
                <a href="/api/round/{{.Code}}/download/sample" class="download-link">
                    <span><i data-lucide="music" class="icon-inline icon-primary"></i> Download Sample</span>
                    <span><i data-lucide="download" class="icon-inline icon-secondary"></i></span>
                </a>
                {{else}}
                <p class="info-box">Waiting for host to upload sample...</p>
                {{end}}
                {{else}}
                <a href="/api/round/{{.Code}}/download/assigned" class="download-link" id="assigned-download">
                    <span><i data-lucide="music" class="icon-inline icon-primary"></i> Download Your Assigned File</span>
                    <span><i data-lucide="download" class="icon-inline icon-secondary"></i></span>
                </a>
                <p class="text-muted mt-1" style="font-size: 0.8125rem;">
                    In telephone mode, you'll remix the previous person's submission.
                </p>
                {{end}}
                {{if and (eq .Round.State "closed") .Round.AllowGuestDownload (not .Participant.IsHost)}}
                <div class="export-section mt-2">
                    <p class="section-title">Round Results</p>
                    <a href="/api/round/{{.Code}}/export" class="btn btn-secondary"><i data-lucide="download" class="icon-inline"></i> Download All Files (ZIP)</a>
                </div>
                {{end}}
            </section>

            <!-- Upload Section (for participants when round is active) -->
            <section class="card" id="upload-section">
                <h2>Your Submission</h2>

                {{$mySubmission := index .Round.Submissions .Participant.ID}}
                {{if $mySubmission}}
                <div class="file-status success" id="submission-status">
                    <span><i data-lucide="check" class="icon-inline"></i> Submitted: {{$mySubmission.OriginalName}}</span>
                </div>
                {{end}}

                <div class="upload-area{{if ne .Round.State "active"}} disabled{{end}}" id="upload-area">
                    <input type="file" id="file-input" accept=".mp3,.wav,.m4a,.flac,.ogg,.aac" {{if ne .Round.State "active"}}disabled{{end}}>
                    <div class="upload-icon"><i data-lucide="headphones" class="icon-lg icon-secondary"></i></div>
                    {{if eq .Round.State "waiting"}}
                    <p class="upload-text">Waiting for round to start...</p>
                    {{else if eq .Round.State "active"}}
                    {{if $mySubmission}}
                    <p class="upload-text">Drop file to replace your submission</p>
                    {{else}}
                    <p class="upload-text">Drop your beat here or click to browse</p>
                    {{end}}
                    <p class="upload-hint">MP3, WAV, M4A, FLAC, OGG, AAC (max 32MB)</p>
                    {{else}}
                    <p class="upload-text">Round is closed</p>
                    {{end}}
                </div>
                <div class="progress-bar hidden" id="upload-progress">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                <p id="upload-status" class="upload-status"></p>
            </section>
            {{else}}
            <!-- Not a participant -->
            <section class="card">
                <p class="info-box">You're viewing this round as a guest. <a href="/">Join to participate</a>.</p>
            </section>
            {{end}}
        </main>

        <footer class="footer">
            <p>Partitionly</p>
        </footer>
    </div>

    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <!-- Pass data to JavaScript via data attributes -->
    <div id="round-data" data-code="{{.Code}}" data-state="{{.Round.State}}" data-mode="{{.Round.Mode}}" data-has-sample="{{if .Round.SampleFileID}}true{{else}}false{{end}}" {{if .Participant}}data-is-participant="true" data-is-host="{{if .Participant.IsHost}}true{{else}}false{{end}}" data-participant-id="{{.Participant.ID}}"{{else}}data-is-participant="false" data-is-host="false" data-participant-id=""{{end}} style="display: none;">
    </div>
    <script src="/static/js/round.js"></script>
    <script>lucide.createIcons();</script>
</body>

</html>